{"ID":"817400c4-3e55-40f7-ae21-555897dce3ad","VersionNumber":4,"Name":"Availability Replicas with Disks in Same Datastore","Description":"<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\r\n\t<head>\r\n\t\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" /><title>\r\n\t\t</title>\r\n\t\t<style type=\"text/css\">\r\n\t\t\t.cs2654AE3A{text-align:left;text-indent:0pt;margin:0pt 0pt 0pt 0pt}\r\n\t\t\t.csBEC5BAA2{color:#000000;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:normal;font-style:normal;}\r\n\t\t\t.csF6EF92FE{color:#000000;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:bold;font-style:normal;}\r\n\t\t\t.cs6BD174F1{color:#000000;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:normal;font-style:normal;text-decoration: none;}\r\n\t\t\t.csC1A17A41{color:#0000FF;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:normal;font-style:normal;text-decoration: underline;}\r\n\t\t</style>\r\n\t</head>\r\n\t<body>\r\n\t\t<p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">This condition evaluates to True when multiple Availability Replicas from the same Availability Group have their VMDKs in the same VMware Datastore.</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">If there is an issue with the Datastore for the VMware server, this could result in an outage that nullifies the Always On Availability Group configuration within the Virtual Machines hosted on the VMware Infrastructure.</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csF6EF92FE\">See Also</span><span class=\"csBEC5BAA2\">:</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\"><a class=\"cs6BD174F1\" href=\"https://blogs.sentryone.com/johnmartin/always_on_availabilitygroupsandvms/\"><span class=\"csC1A17A41\">https://blogs.sentryone.com/johnmartin/always_on_availabilitygroupsandvms/</span></a></span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p></body>\r\n</html>\r\n","AppliesToObjectTypeID":"894de672-3fc0-4779-9a0d-880d4c207c77","ConditionCategoryID":"805a84c9-7f1b-4b4d-a9ad-3dddcf9e0f17","OwnerObjectID":"b7c74f24-1a45-4115-8262-d7613878bbd6","OwnerObjectTypeID":"894de672-3fc0-4779-9a0d-880d4c207c77","RuleDefinition":"{\"OperationTypeID\":\"6c3d38f1-9317-4258-972a-cfee0a0d76b5\",\"Children\":[{\"OperationTypeID\":\"8fa3cd6a-960c-43bb-96e0-94092fc2c296\",\"ValueDataTypeID\":\"b35a57f5-b8f6-4e4e-9380-e9d328e3eabf\",\"Left\":{\"ValueTypeID\":\"f2e88d72-73c6-4ce1-b92a-029c313e707f\",\"Query\":\"--// AG nodes with storage in the same data store.\\r\\n--// Applies to : VMware\\r\\n--// ConditionKey column breakdown as follows;\\r\\n--// Data Store : {Data Store Name} | WSFC : {Windows Cluster Name} | AG : {AG Name} | {Replica:Disk}\\r\\nselect 'Data Store : ' + quotename(ds.name) + N' | WSFC : ' + cr.ClusterName \\r\\n\\t\\t+ ' | AG : ' + ag.name + ' | ' +\\r\\n\\tstuff((select ', ' + ar2.nodename + '('\\r\\n\\t\\t\\t\\t\\t+ case [Role] WHEN 1 THEN 'P' ELSE 'S' END \\r\\n\\t\\t\\t\\t\\t+'):{'+ right(vd.[filename],(charindex('/',reverse(vd.[FileName]))-1)) +'}'\\r\\n\\t\\t\\tfrom vm.virtualMachineVirtualDisk as vd\\r\\n\\t\\t\\tjoin vm.datastore as ds2 \\r\\n\\t\\t\\t\\ton replace(replace(left(vd.filename,charindex(']', vd.filename)),'[',''),']','') = ds2.name\\r\\n\\t\\t\\tjoin vm.virtualMachine as vm2 on vd.virtualMachineId = vm2.id\\r\\n\\t\\t\\tjoin AlwaysOn.AvailabilityReplica as ar2 on vm2.name = ar2.NodeName\\r\\n\\t\\t\\twhere ar2.GroupId = ag.GroupId\\r\\n\\t\\t\\t\\tand ds2.name = ds.name\\r\\n\\t\\t\\torder by vm2.name\\r\\n\\t\\t\\tfor xml path(''), type).value(N'.[1]',N'nvarchar(max)'),1,2,N'') as conditionKey,\\r\\n\\t\\t\\tcount(vmdk.[filename]) as DiskOverlapCount\\r\\nfrom vm.datastore as ds\\r\\njoin vm.virtualMachineVirtualDisk as vmdk\\r\\n\\ton replace(replace(left(vmdk.[filename],charindex(']', vmdk.[filename])),'[',''),']','') = ds.name\\r\\njoin vm.virtualmachine as vm on vmdk.virtualMachineId = vm.id\\r\\njoin AlwaysOn.AvailabilityReplica as ar on ar.nodename = vm.name\\r\\njoin AlwaysOn.AvailabilityGroup as ag on ar.GroupId = ag.GroupId\\r\\njoin AlwaysOn.ClusterReference as cr on ar.EventSourceConnectionID = cr.EventSourceConnectionID\\r\\ngroup by cr.ClusterName, ag.Name, ds.Name, ag.GroupId\\r\\norder by cr.ClusterName, ag.Name, ds.Name\\r\\n;\",\"InstanceType\":1},\"ComparisonType\":2,\"Right\":{\"ValueTypeID\":\"07f87b7f-c063-47a2-a5be-772ba85ed827\",\"Value\":\"1\"},\"ID\":\"1\"}],\"BooleanOperationType\":0,\"ID\":\"0\"}","EvaluationFrequency":"00:05:00","IdlePeriod":"00:00:00","MaximumAllowedDuration":"00:00:05","AntiConditionID":"89eefa84-36db-428e-aaf7-1a5bcb5db607","MinWindowsVersion":null,"MaxWindowsVersion":null,"MinSQLServerVersion":null,"MaxSQLServerVersion":null,"MinSSASVersion":null,"MaxSSASVersion":null,"MinVmwareVersion":null,"MaxVmwareVersion":null,"MinSqlDbVersion":null,"MaxSqlDbVersion":null,"MaximumInstanceCount":100,"ColorIndicator":null,"Severity":2,"Signature":{"ConditionID":"817400c4-3e55-40f7-ae21-555897dce3ad","VersionNumber":4,"AppliesToObjectTypeID":"894de672-3fc0-4779-9a0d-880d4c207c77","RuleDefinition":"{\"OperationTypeID\":\"6c3d38f1-9317-4258-972a-cfee0a0d76b5\",\"Children\":[{\"OperationTypeID\":\"8fa3cd6a-960c-43bb-96e0-94092fc2c296\",\"ValueDataTypeID\":\"b35a57f5-b8f6-4e4e-9380-e9d328e3eabf\",\"Left\":{\"ValueTypeID\":\"f2e88d72-73c6-4ce1-b92a-029c313e707f\",\"Query\":\"--// AG nodes with storage in the same data store.\\r\\n--// Applies to : VMware\\r\\n--// ConditionKey column breakdown as follows;\\r\\n--// Data Store : {Data Store Name} | WSFC : {Windows Cluster Name} | AG : {AG Name} | {Replica:Disk}\\r\\nselect 'Data Store : ' + quotename(ds.name) + N' | WSFC : ' + cr.ClusterName \\r\\n\\t\\t+ ' | AG : ' + ag.name + ' | ' +\\r\\n\\tstuff((select ', ' + ar2.nodename + '('\\r\\n\\t\\t\\t\\t\\t+ case [Role] WHEN 1 THEN 'P' ELSE 'S' END \\r\\n\\t\\t\\t\\t\\t+'):{'+ right(vd.[filename],(charindex('/',reverse(vd.[FileName]))-1)) +'}'\\r\\n\\t\\t\\tfrom vm.virtualMachineVirtualDisk as vd\\r\\n\\t\\t\\tjoin vm.datastore as ds2 \\r\\n\\t\\t\\t\\ton replace(replace(left(vd.filename,charindex(']', vd.filename)),'[',''),']','') = ds2.name\\r\\n\\t\\t\\tjoin vm.virtualMachine as vm2 on vd.virtualMachineId = vm2.id\\r\\n\\t\\t\\tjoin AlwaysOn.AvailabilityReplica as ar2 on vm2.name = ar2.NodeName\\r\\n\\t\\t\\twhere ar2.GroupId = ag.GroupId\\r\\n\\t\\t\\t\\tand ds2.name = ds.name\\r\\n\\t\\t\\torder by vm2.name\\r\\n\\t\\t\\tfor xml path(''), type).value(N'.[1]',N'nvarchar(max)'),1,2,N'') as conditionKey,\\r\\n\\t\\t\\tcount(vmdk.[filename]) as DiskOverlapCount\\r\\nfrom vm.datastore as ds\\r\\njoin vm.virtualMachineVirtualDisk as vmdk\\r\\n\\ton replace(replace(left(vmdk.[filename],charindex(']', vmdk.[filename])),'[',''),']','') = ds.name\\r\\njoin vm.virtualmachine as vm on vmdk.virtualMachineId = vm.id\\r\\njoin AlwaysOn.AvailabilityReplica as ar on ar.nodename = vm.name\\r\\njoin AlwaysOn.AvailabilityGroup as ag on ar.GroupId = ag.GroupId\\r\\njoin AlwaysOn.ClusterReference as cr on ar.EventSourceConnectionID = cr.EventSourceConnectionID\\r\\ngroup by cr.ClusterName, ag.Name, ds.Name, ag.GroupId\\r\\norder by cr.ClusterName, ag.Name, ds.Name\\r\\n;\",\"InstanceType\":1},\"ComparisonType\":2,\"Right\":{\"ValueTypeID\":\"07f87b7f-c063-47a2-a5be-772ba85ed827\",\"Value\":\"1\"},\"ID\":\"1\"}],\"BooleanOperationType\":0,\"ID\":\"0\"}","PublisherID":0,"PublishDateUtc":"2016-10-27T19:57:37","Rights":0,"SignatureVersion":1,"SignaturePublicKey":"<RSAKeyValue><Modulus>uzJQ9gzevXFwOgw/hkcAtD+cA/bBbD1PRzhEZCxbZ6YwjJ1c9bbfXFItLQNwnm8bdWh2k57//qbpEj5DFHOW2EAjHc2Zw5m/vACm6OzelubPS5hbWvzshlaBJKm7KrpWQpPZClx/5eVvUVzOtlz+44RRTiOszObT58acJAQwA70=</Modulus><Exponent>AQAB</Exponent></RSAKeyValue>","Signature":"N2nw8N40CsZxakOmEinEN1WorxZHAL2x7yKQU/tv73IQrj7UidrgFvvFQ/Cv/V+t9Z/4BZoK1Yg01cYALNUteRsJUOmyaVfBoF21vvUphWVrOEbn8fsdIaksImzWEqJQ/dtC//84oQs16WxjoEahMnLsJSK6/dKAQ9lSWkJOvP8=","IsSelfPublishedCondition":true},"Tags":"HA/DR,Virtualization,VMware,UpdateForPublish,11.2.3","Areas":[],"ConditionSystemVersion":3,"MinDBSchemaVersion":null,"MaxDBSchemaVersion":null,"Items":[]}
