{"ID":"5349deb8-272a-4977-863f-39f7e4f133cc","VersionNumber":3,"Name":"Sleeping Sessions with Old Open Transactions (SPID&DB)","Description":"<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\r\n\t<head>\r\n\t\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" /><title>\r\n\t\t</title>\r\n\t\t<style type=\"text/css\">\r\n\t\t\t.cs2654AE3A{text-align:left;text-indent:0pt;margin:0pt 0pt 0pt 0pt}\r\n\t\t\t.csBEC5BAA2{color:#000000;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:normal;font-style:normal;}\r\n\t\t</style>\r\n\t</head>\r\n\t<body>\r\n\t\t<p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">Detects when there are sleeping sessions with open transactions older than 10 minutes by default. Such sessions can cause blocking, and can prevent the transaction log from clearing, leading to excessive log file growth and space exhaustion. Additionally, when snapshot isolation is used, they can prevent version cleanup from occurring in tempdb.</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">The start time, session_id, host, application and database are returned for the oldest 5 transactions by default. The query itself only returns transactions older than 5 minutes by default, to avoid bringing back unnecessary results on systems with many short-running transactions.</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p></body>\r\n</html>\r\n","AppliesToObjectTypeID":"0a11a887-823a-4461-87af-321cad1c3623","ConditionCategoryID":"805a84c9-7f1b-4b4d-a9ad-3dddcf9e0f17","OwnerObjectID":"b7c74f24-1a45-4115-8262-d7613878bbd6","OwnerObjectTypeID":"894de672-3fc0-4779-9a0d-880d4c207c77","RuleDefinition":"{\"OperationTypeID\":\"6c3d38f1-9317-4258-972a-cfee0a0d76b5\",\"Children\":[{\"OperationTypeID\":\"8fa3cd6a-960c-43bb-96e0-94092fc2c296\",\"ValueDataTypeID\":\"b35a57f5-b8f6-4e4e-9380-e9d328e3eabf\",\"Left\":{\"ValueTypeID\":\"aa61ee90-8a95-4fdf-a208-b9a4afa26d9d\",\"Database\":\"master\",\"Query\":\"SELECT 'SPID: ' + CAST([SPID] AS varchar) + ' | ' + 'Database: ' + [Database], [Transaction Length]\\r\\nFROM (\\r\\nSELECT\\r\\n    [s_tst].[session_id] AS [SPID],\\r\\n    [s_es].[login_name] AS [Login Name],\\r\\n    DB_NAME (s_tdt.database_id) AS [Database],\\r\\n    [s_tdt].[database_transaction_begin_time] AS [Begin Time],\\r\\nDATEDIFF(ss, [s_tdt].[database_transaction_begin_time], GETDATE()) [Transaction Length],\\r\\n    [s_tdt].[database_transaction_log_bytes_used] AS [Log Bytes],\\r\\n    [s_tdt].[database_transaction_log_bytes_reserved] AS [Log Rsvd],\\r\\nCASE [s_tdt].database_transaction_type\\r\\n  WHEN 1 THEN 'Read/write transaction'\\r\\n  WHEN 2 THEN 'Read-only transaction'\\r\\n  WHEN 3 THEN 'System transaction'\\r\\nEND [Transaction Type],\\r\\nCASE [s_tdt].database_transaction_state\\r\\n  WHEN 1 THEN 'The transaction has not been initialized.'\\r\\n  WHEN 3 THEN 'The transaction has been initialized but has not generated any log records.'\\r\\n  WHEN 4 THEN 'The transaction has generated log records.'\\r\\n  WHEN 5 THEN 'The transaction has been prepared.'\\r\\n  WHEN 10 THEN 'The transaction has been committed.'\\r\\n  WHEN 11 THEN 'The transaction has been rolled back.'\\r\\n  WHEN 12 THEN 'The transaction is being committed. In this state the log record is being generated, but it has not been materialized or persisted.'\\r\\nEND [Transaction State],\\r\\n[s_est].text AS [Last T-SQL Text]\\r\\nFROM sys.dm_tran_database_transactions [s_tdt]\\r\\nINNER JOIN sys.dm_tran_session_transactions [s_tst]\\r\\nON [s_tst].[transaction_id] = [s_tdt].[transaction_id]\\r\\nINNER JOIN sys.[dm_exec_sessions] [s_es]\\r\\nON [s_es].[session_id] = [s_tst].[session_id]\\r\\nINNER JOIN sys.dm_exec_connections [s_ec]\\r\\nON [s_ec].[session_id] = [s_tst].[session_id]\\r\\nCROSS APPLY sys.dm_exec_sql_text ([s_ec].[most_recent_sql_handle]) AS [s_est]\\r\\nWHERE [s_tst].is_user_transaction = 1 --AND DB_NAME (s_tdt.database_id) = <DatabaseID>\\r\\n) RunningTransactions\\r\\nORDER BY [Transaction Length] desc\",\"InstanceType\":1},\"ComparisonType\":2,\"Right\":{\"ValueTypeID\":\"07f87b7f-c063-47a2-a5be-772ba85ed827\",\"Value\":\"10\"},\"ID\":\"1\"}],\"BooleanOperationType\":0,\"ID\":\"0\"}","EvaluationFrequency":"00:05:00","IdlePeriod":"00:00:00","MaximumAllowedDuration":"00:00:05","AntiConditionID":"f8193fc6-4f05-4b69-bc09-4dea20bd0a00","MinWindowsVersion":null,"MaxWindowsVersion":null,"MinSQLServerVersion":"9.0","MaxSQLServerVersion":null,"MinSSASVersion":null,"MaxSSASVersion":null,"MinVmwareVersion":null,"MaxVmwareVersion":null,"MinSqlDbVersion":null,"MaxSqlDbVersion":null,"MaximumInstanceCount":5,"ColorIndicator":null,"Severity":1,"Signature":{"ConditionID":"5349deb8-272a-4977-863f-39f7e4f133cc","VersionNumber":3,"AppliesToObjectTypeID":"0a11a887-823a-4461-87af-321cad1c3623","RuleDefinition":"{\"OperationTypeID\":\"6c3d38f1-9317-4258-972a-cfee0a0d76b5\",\"Children\":[{\"OperationTypeID\":\"8fa3cd6a-960c-43bb-96e0-94092fc2c296\",\"ValueDataTypeID\":\"b35a57f5-b8f6-4e4e-9380-e9d328e3eabf\",\"Left\":{\"ValueTypeID\":\"aa61ee90-8a95-4fdf-a208-b9a4afa26d9d\",\"Database\":\"master\",\"Query\":\"SELECT 'SPID: ' + CAST([SPID] AS varchar) + ' | ' + 'Database: ' + [Database], [Transaction Length]\\r\\nFROM (\\r\\nSELECT\\r\\n    [s_tst].[session_id] AS [SPID],\\r\\n    [s_es].[login_name] AS [Login Name],\\r\\n    DB_NAME (s_tdt.database_id) AS [Database],\\r\\n    [s_tdt].[database_transaction_begin_time] AS [Begin Time],\\r\\nDATEDIFF(ss, [s_tdt].[database_transaction_begin_time], GETDATE()) [Transaction Length],\\r\\n    [s_tdt].[database_transaction_log_bytes_used] AS [Log Bytes],\\r\\n    [s_tdt].[database_transaction_log_bytes_reserved] AS [Log Rsvd],\\r\\nCASE [s_tdt].database_transaction_type\\r\\n  WHEN 1 THEN 'Read/write transaction'\\r\\n  WHEN 2 THEN 'Read-only transaction'\\r\\n  WHEN 3 THEN 'System transaction'\\r\\nEND [Transaction Type],\\r\\nCASE [s_tdt].database_transaction_state\\r\\n  WHEN 1 THEN 'The transaction has not been initialized.'\\r\\n  WHEN 3 THEN 'The transaction has been initialized but has not generated any log records.'\\r\\n  WHEN 4 THEN 'The transaction has generated log records.'\\r\\n  WHEN 5 THEN 'The transaction has been prepared.'\\r\\n  WHEN 10 THEN 'The transaction has been committed.'\\r\\n  WHEN 11 THEN 'The transaction has been rolled back.'\\r\\n  WHEN 12 THEN 'The transaction is being committed. In this state the log record is being generated, but it has not been materialized or persisted.'\\r\\nEND [Transaction State],\\r\\n[s_est].text AS [Last T-SQL Text]\\r\\nFROM sys.dm_tran_database_transactions [s_tdt]\\r\\nINNER JOIN sys.dm_tran_session_transactions [s_tst]\\r\\nON [s_tst].[transaction_id] = [s_tdt].[transaction_id]\\r\\nINNER JOIN sys.[dm_exec_sessions] [s_es]\\r\\nON [s_es].[session_id] = [s_tst].[session_id]\\r\\nINNER JOIN sys.dm_exec_connections [s_ec]\\r\\nON [s_ec].[session_id] = [s_tst].[session_id]\\r\\nCROSS APPLY sys.dm_exec_sql_text ([s_ec].[most_recent_sql_handle]) AS [s_est]\\r\\nWHERE [s_tst].is_user_transaction = 1 --AND DB_NAME (s_tdt.database_id) = <DatabaseID>\\r\\n) RunningTransactions\\r\\nORDER BY [Transaction Length] desc\",\"InstanceType\":1},\"ComparisonType\":2,\"Right\":{\"ValueTypeID\":\"07f87b7f-c063-47a2-a5be-772ba85ed827\",\"Value\":\"10\"},\"ID\":\"1\"}],\"BooleanOperationType\":0,\"ID\":\"0\"}","PublisherID":0,"PublishDateUtc":"2020-05-07T23:33:29","Rights":0,"SignatureVersion":1,"SignaturePublicKey":"<RSAKeyValue><Modulus>uzJQ9gzevXFwOgw/hkcAtD+cA/bBbD1PRzhEZCxbZ6YwjJ1c9bbfXFItLQNwnm8bdWh2k57//qbpEj5DFHOW2EAjHc2Zw5m/vACm6OzelubPS5hbWvzshlaBJKm7KrpWQpPZClx/5eVvUVzOtlz+44RRTiOszObT58acJAQwA70=</Modulus><Exponent>AQAB</Exponent></RSAKeyValue>","Signature":"a/uCQu8pVkZUyzlumkr9536bv88xDQfCTTyEhfu5SdGpvWNQYqZQ0DdZUXDJJZNOr096bogxxRlTBxCe7KSf6Y2uPww5ocdfW0KYX/S+b+7NNxuzM1imBsneWs9zSXsD10d1c6fYK2X99+9wefoyIuq7FEYJPpsbo6dLsPM63l0=","IsSelfPublishedCondition":true},"Tags":"Performance,S1-Stock AC Pack","Areas":[],"ConditionSystemVersion":3,"MinDBSchemaVersion":null,"MaxDBSchemaVersion":null,"Items":[]}